---
# ç®€åŒ–çš„æœåŠ¡å™¨åˆå§‹åŒ– Playbook
# è¿è¡Œå‘½ä»¤: ansible-playbook -i inventory.yml server-setup.yml

- name: "æœåŠ¡å™¨åŸºç¡€é…ç½®"
  hosts: all
  become: yes
  gather_facts: yes
  
  vars:
    # å¯ä¿®æ”¹çš„å˜é‡
    server_timezone: "Asia/Shanghai"
    install_packages:
      - vim
      - curl
      - wget
      - htop
      - git
      - unzip
      - tree
      - screen
      - tmux
  
  tasks:
    # 1. ç³»ç»ŸåŸºç¡€é…ç½®
    - name: "æ›´æ–°è½¯ä»¶åŒ…ç¼“å­˜"
      apt:
        update_cache: yes
        cache_valid_time: 86400
      when: ansible_os_family == "Debian"
      tags: ['system']

    - name: "è®¾ç½®æ—¶åŒº"
      timezone:
        name: "{{ server_timezone }}"
      tags: ['system']

    - name: "è®¾ç½®ä¸»æœºå"
      hostname:
        name: "{{ inventory_hostname }}"
      tags: ['system']

    # 2. å®‰è£…åŸºç¡€è½¯ä»¶
    - name: "å®‰è£…åŸºç¡€å·¥å…·"
      package:
        name: "{{ install_packages }}"
        state: present
      tags: ['packages']

    - name: "å®‰è£…PythonåŒ…"
      package:
        name:
          - python3
          - python3-pip
        state: present
      tags: ['packages']

    # 3. ç³»ç»Ÿä¼˜åŒ–é…ç½®
    - name: "é…ç½®ç³»ç»Ÿlimits"
      copy:
        dest: /etc/security/limits.d/99-custom.conf
        content: |
          * soft nofile 65536
          * hard nofile 65536
          * soft nproc 32768
          * hard nproc 32768
        backup: yes
      tags: ['optimize']

    - name: "é…ç½®åŸºç¡€ç½‘ç»œå‚æ•°"
      sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        state: present
        reload: yes
      loop:
        - { name: 'net.core.somaxconn', value: '65535' }
        - { name: 'net.ipv4.tcp_fin_timeout', value: '10' }
        - { name: 'net.ipv4.tcp_keepalive_time', value: '1200' }
      ignore_errors: yes
      tags: ['optimize']

    # 4. å®‰å…¨é…ç½®
    - name: "é…ç½®SSHå®‰å…¨"
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        backup: yes
      loop:
        - { regexp: '^#?PasswordAuthentication', line: 'PasswordAuthentication no' }
        - { regexp: '^#?PubkeyAuthentication', line: 'PubkeyAuthentication yes' }
        - { regexp: '^#?MaxAuthTries', line: 'MaxAuthTries 3' }
      notify: restart ssh
      tags: ['security']

    # 5. åˆ›å»ºæœ‰ç”¨çš„åˆ«å
    - name: "åˆ›å»ºç³»ç»Ÿåˆ«å"
      copy:
        dest: /etc/profile.d/aliases.sh
        content: |
          alias ll='ls -alF'
          alias la='ls -A'
          alias l='ls -CF'
          alias ..='cd ..'
          alias df='df -h'
          alias free='free -h'
          alias top='htop'
        mode: '0644'
      tags: ['config']

    # 6. æ˜¾ç¤ºå®Œæˆä¿¡æ¯
    - name: "æ˜¾ç¤ºé…ç½®å®Œæˆä¿¡æ¯"
      debug:
        msg: |
          âœ… æœåŠ¡å™¨é…ç½®å®Œæˆï¼
          ğŸ“ ä¸»æœº: {{ inventory_hostname }}
          ğŸ–¥ï¸  ç³»ç»Ÿ: {{ ansible_distribution }} {{ ansible_distribution_version }}
          ğŸ”§ å·²å®‰è£…å·¥å…·: {{ install_packages | join(', ') }}
          ğŸ• æ—¶åŒº: {{ server_timezone }}
      tags: ['info']

  handlers:
    - name: restart ssh
      service:
        name: ssh
        state: restarted 