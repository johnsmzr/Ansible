---
# ç®€åŒ–çš„æœåŠ¡å™¨åˆå§‹åŒ– Playbook
# è¿è¡Œå‘½ä»¤: ansible-playbook -i inventory.yml server-setup.yml

- name: "æœåŠ¡å™¨åŸºç¡€é…ç½®"
  hosts: all
  become: yes
  gather_facts: yes
  
  vars:
    # å¯ä¿®æ”¹çš„å˜é‡
    server_timezone: "Asia/Shanghai"
    # SSHå…¬é’¥é…ç½® - è¯·æ·»åŠ ä½ çš„å…¬é’¥å†…å®¹
    ssh_public_keys:
      - "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC... your-public-key-here"
      # - "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAI... another-key-here"
    
    # ç”¨æˆ·é…ç½®
    admin_users:
      - name: "{{ ansible_user }}"  # ä½¿ç”¨å½“å‰è¿æ¥çš„ç”¨æˆ·
        groups: ["sudo"]
        shell: "/bin/bash"
    
    install_packages:
      - vim
      - curl
      - wget
      - htop
      - git
      - unzip
      - tree
      - screen
      - tmux
  
  tasks:
    # 1. ç³»ç»ŸåŸºç¡€é…ç½®
    - name: "æ›´æ–°è½¯ä»¶åŒ…ç¼“å­˜"
      apt:
        update_cache: yes
        cache_valid_time: 86400
      when: ansible_os_family == "Debian"
      tags: ['system']

    - name: "è®¾ç½®æ—¶åŒº"
      timezone:
        name: "{{ server_timezone }}"
      tags: ['system']

    - name: "ç¡®ä¿æ—¶åŒºé…ç½®æ–‡ä»¶æ­£ç¡®"
      file:
        src: "/usr/share/zoneinfo/{{ server_timezone }}"
        dest: "/etc/localtime"
        state: link
        force: yes
      tags: ['system']

    - name: "å†™å…¥æ—¶åŒºåˆ°/etc/timezone"
      copy:
        content: "{{ server_timezone }}\n"
        dest: /etc/timezone
        mode: '0644'
      tags: ['system']

    - name: "è®¾ç½®ä¸»æœºååˆ°/etc/hostname"
      copy:
        content: "{{ inventory_hostname }}\n"
        dest: /etc/hostname
        mode: '0644'
      tags: ['system']

    - name: "è®¾ç½®è¿è¡Œæ—¶ä¸»æœºå"
      hostname:
        name: "{{ inventory_hostname }}"
      tags: ['system']

    - name: "æ›´æ–°/etc/hostsæ–‡ä»¶"
      lineinfile:
        path: /etc/hosts
        regexp: '^127\.0\.1\.1'
        line: "127.0.1.1\t{{ inventory_hostname }}"
        backup: yes
      tags: ['system']

    - name: "ç¡®ä¿localhostæ¡ç›®å­˜åœ¨"
      lineinfile:
        path: /etc/hosts
        regexp: '^127\.0\.0\.1'
        line: "127.0.0.1\tlocalhost"
        backup: yes
      tags: ['system']

    # 2. å®‰è£…åŸºç¡€è½¯ä»¶
    - name: "å®‰è£…åŸºç¡€å·¥å…·"
      package:
        name: "{{ install_packages }}"
        state: present
      tags: ['packages']

    - name: "å®‰è£…PythonåŒ…"
      package:
        name:
          - python3
          - python3-pip
        state: present
      tags: ['packages']

    # 3. ç”¨æˆ·å’ŒSSHå¯†é’¥ç®¡ç†
    - name: "ç¡®ä¿ç®¡ç†å‘˜ç”¨æˆ·å­˜åœ¨"
      user:
        name: "{{ item.name }}"
        groups: "{{ item.groups }}"
        shell: "{{ item.shell }}"
        append: yes
        create_home: yes
      loop: "{{ admin_users }}"
      tags: ['users', 'security']

    - name: "ä¸ºç®¡ç†å‘˜ç”¨æˆ·åˆ›å»º.sshç›®å½•"
      file:
        path: "/home/{{ item.name }}/.ssh"
        state: directory
        owner: "{{ item.name }}"
        group: "{{ item.name }}"
        mode: '0700'
      loop: "{{ admin_users }}"
      when: item.name != 'root'
      tags: ['users', 'security']

    - name: "ä¸ºrootç”¨æˆ·åˆ›å»º.sshç›®å½•"
      file:
        path: "/root/.ssh"
        state: directory
        owner: root
        group: root
        mode: '0700'
      when: "'root' in admin_users | map(attribute='name') | list"
      tags: ['users', 'security']

    - name: "æ·»åŠ SSHå…¬é’¥åˆ°ç®¡ç†å‘˜ç”¨æˆ·"
      authorized_key:
        user: "{{ item.0.name }}"
        key: "{{ item.1 }}"
        state: present
        exclusive: no
      loop: "{{ admin_users | product(ssh_public_keys) | list }}"
      when: ssh_public_keys is defined and ssh_public_keys | length > 0
      tags: ['users', 'security']

    - name: "éªŒè¯SSHå…¬é’¥æ˜¯å¦å·²æ­£ç¡®é…ç½®"
      command: "ls -la /home/{{ ansible_user }}/.ssh/authorized_keys"
      register: ssh_key_check
      failed_when: false
      changed_when: false
      when: ansible_user != 'root'
      tags: ['security', 'verify']

    - name: "éªŒè¯rootç”¨æˆ·SSHå…¬é’¥é…ç½®"
      command: "ls -la /root/.ssh/authorized_keys"
      register: root_ssh_key_check
      failed_when: false
      changed_when: false
      when: ansible_user == 'root'
      tags: ['security', 'verify']

    - name: "æ˜¾ç¤ºSSHå¯†é’¥é…ç½®çŠ¶æ€"
      debug:
        msg: |
          ğŸ”‘ SSHå¯†é’¥é…ç½®çŠ¶æ€:
          {% if ansible_user != 'root' and ssh_key_check.rc == 0 %}
          âœ… ç”¨æˆ· {{ ansible_user }} çš„å…¬é’¥å·²é…ç½®
          {% elif ansible_user == 'root' and root_ssh_key_check.rc == 0 %}
          âœ… rootç”¨æˆ·çš„å…¬é’¥å·²é…ç½®
          {% else %}
          âš ï¸  è­¦å‘Šï¼šæœªæ£€æµ‹åˆ°SSHå…¬é’¥é…ç½®ï¼
          {% endif %}
          
          ğŸ“ è¯·ç¡®è®¤ä»¥ä¸‹å…¬é’¥å·²æ­£ç¡®æ·»åŠ ï¼š
          {% for key in ssh_public_keys %}
          - {{ key[:50] }}...
          {% endfor %}
      when: ssh_public_keys is defined
      tags: ['security', 'verify']

    # 4. ç³»ç»Ÿä¼˜åŒ–é…ç½®
    - name: "é…ç½®ç³»ç»Ÿlimits"
      copy:
        dest: /etc/security/limits.d/99-custom.conf
        content: |
          * soft nofile 65536
          * hard nofile 65536
          * soft nproc 32768
          * hard nproc 32768
        backup: yes
      tags: ['optimize']

    - name: "é…ç½®åŸºç¡€ç½‘ç»œå‚æ•°"
      sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        state: present
        reload: yes
      loop:
        - { name: 'net.core.somaxconn', value: '65535' }
        - { name: 'net.ipv4.tcp_fin_timeout', value: '10' }
        - { name: 'net.ipv4.tcp_keepalive_time', value: '1200' }
      ignore_errors: yes
      tags: ['optimize']

    # 5. SSHå®‰å…¨é…ç½®ï¼ˆåœ¨å…¬é’¥é…ç½®å®Œæˆåï¼‰
    - name: "è­¦å‘Šï¼šå³å°†é…ç½®SSHå®‰å…¨è®¾ç½®"
      pause:
        prompt: |
          âš ï¸  å³å°†ç¦ç”¨SSHå¯†ç è®¤è¯ï¼
          
          è¯·ç¡®è®¤ï¼š
          1. SSHå…¬é’¥å·²æ­£ç¡®é…ç½®
          2. ä½ èƒ½å¤Ÿä½¿ç”¨å¯†é’¥ç™»å½•
          
          æŒ‰ Enter ç»§ç»­ï¼Œæˆ– Ctrl+C å–æ¶ˆ
        seconds: 10
      when: ssh_public_keys is defined and ssh_public_keys | length > 0
      tags: ['security']

    - name: "é…ç½®SSHå®‰å…¨è®¾ç½®"
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        backup: yes
      loop:
        - { regexp: '^#?PasswordAuthentication', line: 'PasswordAuthentication no' }
        - { regexp: '^#?PubkeyAuthentication', line: 'PubkeyAuthentication yes' }
        - { regexp: '^#?MaxAuthTries', line: 'MaxAuthTries 3' }
        - { regexp: '^#?PermitRootLogin', line: 'PermitRootLogin prohibit-password' }
        - { regexp: '^#?AuthorizedKeysFile', line: 'AuthorizedKeysFile .ssh/authorized_keys' }
      notify: restart ssh
      when: ssh_public_keys is defined and ssh_public_keys | length > 0
      tags: ['security']

    - name: "è·³è¿‡SSHå®‰å…¨é…ç½®ï¼ˆæœªé…ç½®å…¬é’¥ï¼‰"
      debug:
        msg: |
          âš ï¸  è·³è¿‡SSHå®‰å…¨é…ç½®ï¼
          
          åŸå› ï¼šæœªé…ç½®SSHå…¬é’¥
          
          è¦å¯ç”¨SSHå®‰å…¨é…ç½®ï¼Œè¯·ï¼š
          1. åœ¨varsä¸­æ·»åŠ ä½ çš„SSHå…¬é’¥åˆ° ssh_public_keys
          2. é‡æ–°è¿è¡Œplaybookï¼šansible-playbook server-setup.yml --tags security
      when: ssh_public_keys is not defined or ssh_public_keys | length == 0
      tags: ['security']

    # 6. åˆ›å»ºæœ‰ç”¨çš„åˆ«å
    - name: "åˆ›å»ºç³»ç»Ÿåˆ«å"
      copy:
        dest: /etc/profile.d/aliases.sh
        content: |
          alias ll='ls -alF'
          alias la='ls -A'
          alias l='ls -CF'
          alias ..='cd ..'
          alias df='df -h'
          alias free='free -h'
          alias top='htop'
        mode: '0644'
      tags: ['config']

    # 7. éªŒè¯é…ç½®
    - name: "éªŒè¯æ—¶åŒºè®¾ç½®"
      command: timedatectl show --property=Timezone --value
      register: current_timezone
      changed_when: false
      tags: ['system', 'verify']

    - name: "éªŒè¯ä¸»æœºåè®¾ç½®"
      command: hostname
      register: current_hostname
      changed_when: false
      tags: ['system', 'verify']

    # 8. æ˜¾ç¤ºå®Œæˆä¿¡æ¯
    - name: "æ˜¾ç¤ºé…ç½®å®Œæˆä¿¡æ¯"
      debug:
        msg: |
          âœ… æœåŠ¡å™¨é…ç½®å®Œæˆï¼
          ğŸ“ ä¸»æœº: {{ inventory_hostname }} (å½“å‰: {{ current_hostname.stdout }})
          ğŸ–¥ï¸  ç³»ç»Ÿ: {{ ansible_distribution }} {{ ansible_distribution_version }}
          ğŸ”§ å·²å®‰è£…å·¥å…·: {{ install_packages | join(', ') }}
          ğŸ• æ—¶åŒº: {{ server_timezone }} (å½“å‰: {{ current_timezone.stdout }})
          ğŸ‘¤ ç®¡ç†å‘˜ç”¨æˆ·: {{ admin_users | map(attribute='name') | join(', ') }}
          
          {% if ssh_public_keys is defined and ssh_public_keys | length > 0 %}
          ğŸ” SSHå®‰å…¨: å·²å¯ç”¨å¯†é’¥è®¤è¯ï¼Œå·²ç¦ç”¨å¯†ç ç™»å½•
          {% else %}
          âš ï¸  SSHå®‰å…¨: æœªé…ç½®ï¼ˆä»å…è®¸å¯†ç ç™»å½•ï¼‰
          {% endif %}
          
          ğŸ’¡ ä¸‹æ¬¡ç™»å½•è¯·ä½¿ç”¨: ssh -i ~/.ssh/your_private_key {{ ansible_user }}@{{ ansible_host }}
      tags: ['info']

  handlers:
    - name: restart ssh
      service:
        name: ssh
        state: restarted 